{% extends "base.html" %}
{% block content %}
<h1>My Ratings</h1>
<div class="row">
  <input id="email" placeholder="email"/>
  <input id="password" placeholder="password" type="password"/>
  <button id="btn-signup">Signup</button>
  <button id="btn-login">Login</button>
</div>
<table id="tbl" class="table">
  <thead><tr><th>Movie</th><th>Score</th><th>Actions</th></tr></thead>
  <tbody></tbody>
</table>
<script>
async function signup(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const r=await fetch('/api/auth/signup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
  const d=await r.json(); if(d.access_token){localStorage.setItem('token', d.access_token); alert('Signed up & logged in!'); load();}
  else alert(JSON.stringify(d));
}
async function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
  const d=await r.json(); if(d.access_token){localStorage.setItem('token', d.access_token); alert('Logged in!'); load();}
  else alert(JSON.stringify(d));
}
document.getElementById('btn-signup').onclick=signup;
document.getElementById('btn-login').onclick=login;

async function load(){
  const token=localStorage.getItem('token')||'';
  const r=await fetch('/api/ratings/me',{headers:{'Authorization':'Bearer '+token}});
  const data= r.status===200 ? await r.json() : [];
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  data.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${x.title}</td>
      <td><input type="number" min="1" max="5" value="${x.score}" id="s-${x.movie_id}"/></td>
      <td>
        <button onclick="save(${x.movie_id})">Update</button>
        <button onclick="delr(${x.movie_id})">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
}
async function save(movie_id){
  const score=parseInt(document.getElementById('s-'+movie_id).value);
  const token=localStorage.getItem('token')||'';
  await fetch('/api/ratings',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({movie_id,score})});
  load();
}
async function delr(movie_id){
  const token=localStorage.getItem('token')||'';
  await fetch('/api/ratings/'+movie_id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
  load();
}
load();
</script>
{% endblock %}
